extern crate log;
extern crate simplelog;

use log::{debug, error};
use std::fs;
use std::io::prelude::*;

// enabled only during testing.
// supports reaching into the resources dir for test data.
// TODO: doesn't work nicely work vscode-rls (which doesn't pass along the features=test)
// #[cfg(feature = "test")]
//pub mod rsrc;

//pub mod analysis;

pub mod arch;
pub mod util;
pub mod xref;
pub mod loader;
pub mod flowmeta;
pub mod workspace;

#[derive(Debug)]
pub enum Error {
    FileAccess,
    FileFormat,
    NotImplemented(&'static str),
    InvalidRva,
    InvalidVa,
}

pub fn read_file(filename: &str) -> Result<Vec<u8>, Error> {
    debug!("read_file: {:?}", filename);

    let mut buf = Vec::new();
    {
        debug!("reading file: {}", filename);
        let mut f = match fs::File::open(filename) {
            Ok(f) => f,
            Err(_) => {
                error!("failed to open file: {}", filename);
                return Err(Error::FileAccess);
            }
        };
        let bytes_read = match f.read_to_end(&mut buf) {
            Ok(c) => c,
            Err(_) => {
                error!("failed to read entire file: {}", filename);
                return Err(Error::FileAccess);
            }
        };
        debug!("read {} bytes", bytes_read);
        if bytes_read < 0x10 {
            error!("file too small: {}", filename);
            return Err(Error::FileFormat);
        }
    }

    Ok(buf)
}
